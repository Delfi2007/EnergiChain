<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Computer Vision Safety Scanner ‚Äî EnergiChain</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    .scanner-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-top: 2rem;
    }
    
    .camera-view {
      background: #000;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      aspect-ratio: 4/3;
      border: 2px solid var(--accent);
      box-shadow: 0 0 30px rgba(0,255,136,0.3);
    }
    
    #videoElement {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }
    
    .scan-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 70%;
      border: 3px solid var(--accent);
      border-radius: 10px;
      animation: scanPulse 2s ease-in-out infinite;
    }
    
    @keyframes scanPulse {
      0%, 100% { opacity: 0.5; box-shadow: 0 0 20px var(--accent); }
      50% { opacity: 1; box-shadow: 0 0 40px var(--accent); }
    }
    
    .scan-line {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 70%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      animation: scanMove 2s linear infinite;
    }
    
    @keyframes scanMove {
      0% { top: 15%; opacity: 1; }
      100% { top: 85%; opacity: 0.3; }
    }
    
    .corner-marker {
      position: absolute;
      width: 40px;
      height: 40px;
      border: 3px solid var(--accent);
    }
    
    .corner-marker.tl { top: 15%; left: 15%; border-right: none; border-bottom: none; }
    .corner-marker.tr { top: 15%; right: 15%; border-left: none; border-bottom: none; }
    .corner-marker.bl { bottom: 15%; left: 15%; border-right: none; border-top: none; }
    .corner-marker.br { bottom: 15%; right: 15%; border-left: none; border-top: none; }
    
    .scan-status {
      position: absolute;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      padding: 0.5rem 1.5rem;
      border-radius: 20px;
      border: 1px solid var(--accent);
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--accent);
      display: none;
    }
    
    .scan-status.active {
      display: block;
      animation: blink 1s ease-in-out infinite;
    }
    
    .detection-box {
      position: absolute;
      border: 2px solid #ff0000;
      background: rgba(255,0,0,0.1);
      animation: detectPulse 0.5s ease-in-out;
    }
    
    @keyframes detectPulse {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .detection-label {
      position: absolute;
      background: #ff0000;
      color: #fff;
      padding: 2px 8px;
      font-size: 0.7rem;
      font-weight: 600;
      border-radius: 3px;
      top: -25px;
      left: 0;
    }
    
    .camera-controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1rem;
    }
    
    .analysis-panel {
      display: grid;
      gap: 1.5rem;
    }
    
    .issue-card {
      padding: 1.5rem;
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      border-left: 4px solid #666;
      transition: all 0.3s ease;
    }
    
    .issue-card.critical {
      border-left-color: #ff0000;
      background: rgba(255,0,0,0.1);
    }
    
    .issue-card.warning {
      border-left-color: #ffaa00;
      background: rgba(255,170,0,0.1);
    }
    
    .issue-card.safe {
      border-left-color: var(--accent);
      background: rgba(0,255,136,0.05);
    }
    
    .severity-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .severity-badge.critical {
      background: #ff0000;
      color: #fff;
    }
    
    .severity-badge.warning {
      background: #ffaa00;
      color: #000;
    }
    
    .severity-badge.safe {
      background: var(--accent);
      color: #000;
    }
    
    .scan-progress {
      width: 100%;
      height: 6px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 1rem;
    }
    
    .scan-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #00c8ff);
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s ease;
      animation: progressShine 2s ease-in-out infinite;
    }
    
    @keyframes progressShine {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    @media (max-width: 768px) {
      .scanner-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div style="display:flex;align-items:center;gap:1rem">
      <div class="brand">EnergiChain</div>
      <span style="font-size:0.9rem;color:#666">|</span>
      <span style="font-size:0.9rem;color:#999">CV Safety Scanner</span>
    </div>
    <nav>
      <a href="index.html" style="display:flex;align-items:center;gap:0.5rem">
        ‚Üê Dashboard
      </a>
    </nav>
  </header>
  
  <main style="padding:2rem;max-width:1400px;margin:0 auto">
    <!-- Header Section -->
    <div style="text-align:center;margin-bottom:3rem">
      <h1 style="font-size:2.5rem;margin-bottom:1rem;background:linear-gradient(135deg,var(--accent),#00c8ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">
        üì∑ Computer Vision Safety Scanner
      </h1>
      <p style="font-size:1.1rem;color:#999;line-height:1.6">
        AI-powered cylinder inspection using your device camera
      </p>
    </div>

    <!-- Stats Section -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-bottom:2rem">
      <div style="padding:1.5rem;background:rgba(0,0,0,0.3);border:1px solid #333;border-radius:12px;text-align:center">
        <div style="font-size:2rem;font-weight:700;color:var(--accent)" id="totalScans">3,847</div>
        <div style="font-size:0.85rem;color:#999;margin-top:0.5rem">Scans Completed</div>
      </div>
      <div style="padding:1.5rem;background:rgba(0,0,0,0.3);border:1px solid #333;border-radius:12px;text-align:center">
        <div style="font-size:2rem;font-weight:700;color:#ff0000">12.4%</div>
        <div style="font-size:0.85rem;color:#999;margin-top:0.5rem">Defects Detected</div>
      </div>
      <div style="padding:1.5rem;background:rgba(0,0,0,0.3);border:1px solid #333;border-radius:12px;text-align:center">
        <div style="font-size:2rem;font-weight:700;color:var(--accent)">98.2%</div>
        <div style="font-size:0.85rem;color:#999;margin-top:0.5rem">Accuracy Rate</div>
      </div>
      <div style="padding:1.5rem;background:rgba(0,0,0,0.3);border:1px solid #333;border-radius:12px;text-align:center">
        <div style="font-size:2rem;font-weight:700;color:var(--accent)">< 3s</div>
        <div style="font-size:0.85rem;color:#999;margin-top:0.5rem">Scan Time</div>
      </div>
    </div>

    <!-- Scanner Interface -->
    <div class="scanner-container">
      <!-- Camera View -->
      <div>
        <div class="camera-view">
          <video id="videoElement" autoplay playsinline></video>
          <canvas id="canvasElement" style="display:none"></canvas>
          
          <div class="scanner-overlay" id="scannerOverlay">
            <div class="scan-frame"></div>
            <div class="scan-line"></div>
            <div class="corner-marker tl"></div>
            <div class="corner-marker tr"></div>
            <div class="corner-marker bl"></div>
            <div class="corner-marker br"></div>
            <div class="scan-status" id="scanStatus">üîç SCANNING...</div>
          </div>
          
          <div id="detectionOverlay" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none"></div>
        </div>
        
        <div class="camera-controls">
          <button onclick="startCamera()" id="startBtn" style="padding:1rem 2rem">
            üìπ Start Camera
          </button>
          <button onclick="runScan()" id="scanBtn" style="padding:1rem 2rem;display:none">
            üîç Run Scan
          </button>
          <button onclick="captureImage()" id="captureBtn" style="padding:1rem 2rem;display:none">
            üì∏ Capture
          </button>
          <button onclick="stopCamera()" id="stopBtn" style="padding:1rem 2rem;display:none">
            ‚èπÔ∏è Stop
          </button>
        </div>
        
        <div id="scanProgress" style="display:none;margin-top:1rem">
          <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
            <span style="font-size:0.85rem;color:#999">Analysis Progress</span>
            <span style="font-size:0.85rem;color:var(--accent);font-weight:600" id="progressText">0%</span>
          </div>
          <div class="scan-progress">
            <div class="scan-progress-bar" id="progressBar"></div>
          </div>
        </div>
      </div>

      <!-- Analysis Results -->
      <div class="analysis-panel">
        <div class="action-panel">
          <h3>üîç Scan Results</h3>
          <div id="resultsContainer" style="margin-top:1rem">
            <div style="text-align:center;padding:3rem 1rem;color:#666">
              <div style="font-size:3rem;margin-bottom:1rem">üì∑</div>
              <div style="font-size:1rem">Start camera and run scan to analyze cylinder safety</div>
            </div>
          </div>
        </div>

        <div class="action-panel">
          <h3>ü§ñ AI Detection Model</h3>
          <div style="display:grid;gap:1rem;margin-top:1rem">
            <div style="padding:1rem;background:rgba(0,255,136,0.05);border-radius:8px;border-left:3px solid var(--accent)">
              <div style="font-size:0.85rem;color:#999;margin-bottom:0.5rem">Model Version</div>
              <div style="font-weight:600">YOLOv8-Safety v2.1</div>
            </div>
            <div style="padding:1rem;background:rgba(0,255,136,0.05);border-radius:8px;border-left:3px solid var(--accent)">
              <div style="font-size:0.85rem;color:#999;margin-bottom:0.5rem">Detection Classes</div>
              <div style="font-weight:600">Rust, Dents, Valve Damage, Leaks</div>
            </div>
            <div style="padding:1rem;background:rgba(0,255,136,0.05);border-radius:8px;border-left:3px solid var(--accent)">
              <div style="font-size:0.85rem;color:#999;margin-bottom:0.5rem">Confidence Threshold</div>
              <div style="font-weight:600">85% minimum</div>
            </div>
            <div style="padding:1rem;background:rgba(0,255,136,0.05);border-radius:8px;border-left:3px solid var(--accent)">
              <div style="font-size:0.85rem;color:#999;margin-bottom:0.5rem">Training Dataset</div>
              <div style="font-weight:600">47,000+ cylinder images</div>
            </div>
          </div>
        </div>

        <div class="action-panel">
          <h3>üìä Detection Statistics</h3>
          <div style="display:grid;gap:0.75rem;margin-top:1rem;font-size:0.9rem">
            <div style="display:flex;justify-content:space-between;padding:0.75rem;background:rgba(255,0,0,0.1);border-radius:6px">
              <span>üî¥ Critical Issues</span>
              <span style="color:#ff0000;font-weight:700" id="criticalCount">0</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:0.75rem;background:rgba(255,170,0,0.1);border-radius:6px">
              <span>üü° Warnings</span>
              <span style="color:#ffaa00;font-weight:700" id="warningCount">0</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:0.75rem;background:rgba(0,255,136,0.05);border-radius:6px">
              <span>üü¢ Safe</span>
              <span style="color:var(--accent);font-weight:700" id="safeCount">0</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Safety Guidelines -->
    <div class="action-panel" style="margin-top:2rem">
      <h3>‚ö†Ô∏è Safety Guidelines</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;margin-top:1rem">
        <div style="padding:1rem;background:rgba(0,0,0,0.2);border-radius:8px;border-left:3px solid var(--accent)">
          <div style="font-size:1.2rem;margin-bottom:0.5rem">‚úÖ DO</div>
          <ul style="color:#999;font-size:0.9rem;line-height:1.8;margin:0;padding-left:1.5rem">
            <li>Scan cylinder before every refill</li>
            <li>Ensure good lighting conditions</li>
            <li>Check all sides of the cylinder</li>
            <li>Report critical issues immediately</li>
          </ul>
        </div>
        <div style="padding:1rem;background:rgba(0,0,0,0.2);border-radius:8px;border-left:3px solid #ff0000">
          <div style="font-size:1.2rem;margin-bottom:0.5rem">‚ùå DON'T</div>
          <ul style="color:#999;font-size:0.9rem;line-height:1.8;margin:0;padding-left:1.5rem">
            <li>Use damaged cylinders</li>
            <li>Ignore rust or corrosion</li>
            <li>Skip safety inspections</li>
            <li>Attempt repairs yourself</li>
          </ul>
        </div>
        <div style="padding:1rem;background:rgba(0,0,0,0.2);border-radius:8px;border-left:3px solid #ffaa00">
          <div style="font-size:1.2rem;margin-bottom:0.5rem">‚ö° ACTIONS</div>
          <ul style="color:#999;font-size:0.9rem;line-height:1.8;margin:0;padding-left:1.5rem">
            <li>Contact support for critical issues</li>
            <li>Schedule professional inspection</li>
            <li>Request cylinder replacement</li>
            <li>Download scan report</li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <script type="module" src="../main.js"></script>
  <script>
    let stream = null;
    let scanCount = 3847;
    let isScanning = false;
    
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        });
        
        const video = document.getElementById('videoElement');
        video.srcObject = stream;
        
        // Update UI
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('scanBtn').style.display = 'inline-block';
        document.getElementById('captureBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').style.display = 'inline-block';
        document.getElementById('scannerOverlay').style.display = 'block';
        
      } catch (err) {
        alert('Camera access denied or not available. Error: ' + err.message);
        console.error('Camera error:', err);
      }
    }
    
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        document.getElementById('videoElement').srcObject = null;
      }
      
      // Reset UI
      document.getElementById('startBtn').style.display = 'inline-block';
      document.getElementById('scanBtn').style.display = 'none';
      document.getElementById('captureBtn').style.display = 'none';
      document.getElementById('stopBtn').style.display = 'none';
      document.getElementById('scanProgress').style.display = 'none';
    }
    
    async function runScan() {
      if (isScanning) return;
      isScanning = true;
      
      // Show scanning UI
      document.getElementById('scanStatus').classList.add('active');
      document.getElementById('scanProgress').style.display = 'block';
      document.getElementById('scanBtn').disabled = true;
      
      // Simulate AI analysis with progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 100) progress = 100;
        
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = Math.floor(progress) + '%';
        
        if (progress >= 100) {
          clearInterval(progressInterval);
          setTimeout(() => {
            completeScan();
          }, 500);
        }
      }, 200);
    }
    
    function completeScan() {
      // Hide scanning UI
      document.getElementById('scanStatus').classList.remove('active');
      document.getElementById('scanBtn').disabled = false;
      isScanning = false;
      
      // Update stats
      scanCount++;
      document.getElementById('totalScans').textContent = scanCount.toLocaleString();
      
      // Generate random detection results
      const detections = generateDetections();
      displayResults(detections);
      
      // Draw detection boxes on overlay
      drawDetections(detections);
      
      // Reset progress after delay
      setTimeout(() => {
        document.getElementById('scanProgress').style.display = 'none';
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressText').textContent = '0%';
      }, 2000);
    }
    
    function generateDetections() {
      const scenarios = [
        // Safe cylinder
        {
          results: [
            { type: 'Overall Status', severity: 'safe', confidence: 98, description: 'Cylinder is in excellent condition', recommendation: 'Safe for use' }
          ],
          boxes: []
        },
        // Minor issues
        {
          results: [
            { type: 'Surface Rust', severity: 'warning', confidence: 87, description: 'Minor surface rust detected on lower body', recommendation: 'Monitor condition, clean surface' },
            { type: 'Overall Status', severity: 'warning', confidence: 82, description: 'Cylinder requires attention', recommendation: 'Schedule inspection within 30 days' }
          ],
          boxes: [
            { x: 20, y: 60, width: 30, height: 15, label: 'Rust 87%' }
          ]
        },
        // Critical issues
        {
          results: [
            { type: 'Deep Corrosion', severity: 'critical', confidence: 94, description: 'Severe corrosion detected on valve area', recommendation: 'DO NOT USE - Replace immediately' },
            { type: 'Dent', severity: 'warning', confidence: 89, description: 'Structural dent on side panel', recommendation: 'Professional inspection required' },
            { type: 'Overall Status', severity: 'critical', confidence: 95, description: 'Cylinder UNSAFE for use', recommendation: 'Contact support: +91 98400 12345' }
          ],
          boxes: [
            { x: 35, y: 15, width: 30, height: 20, label: 'Corrosion 94%' },
            { x: 55, y: 45, width: 25, height: 20, label: 'Dent 89%' }
          ]
        },
        // Valve issues
        {
          results: [
            { type: 'Valve Damage', severity: 'critical', confidence: 91, description: 'Valve seal compromised - potential gas leak', recommendation: 'STOP USE - Call emergency: +91 98400 12345' },
            { type: 'Minor Scratches', severity: 'warning', confidence: 78, description: 'Surface scratches detected', recommendation: 'Cosmetic only, monitor condition' }
          ],
          boxes: [
            { x: 40, y: 10, width: 20, height: 15, label: 'Valve 91%' },
            { x: 25, y: 50, width: 20, height: 15, label: 'Scratch 78%' }
          ]
        }
      ];
      
      return scenarios[Math.floor(Math.random() * scenarios.length)];
    }
    
    function displayResults(detections) {
      const container = document.getElementById('resultsContainer');
      const { results, boxes } = detections;
      
      let critical = 0, warning = 0, safe = 0;
      
      let html = '<div style="display:grid;gap:1rem">';
      
      results.forEach(result => {
        if (result.severity === 'critical') critical++;
        else if (result.severity === 'warning') warning++;
        else safe++;
        
        html += `
          <div class="issue-card ${result.severity}">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem">
              <div>
                <div style="font-size:1.1rem;font-weight:700;margin-bottom:0.5rem">${result.type}</div>
                <span class="severity-badge ${result.severity}">${result.severity}</span>
              </div>
              <div style="text-align:right">
                <div style="font-size:1.5rem;font-weight:700;color:var(--accent)">${result.confidence}%</div>
                <div style="font-size:0.75rem;color:#999">Confidence</div>
              </div>
            </div>
            <div style="margin-bottom:0.75rem;color:#ccc;line-height:1.6">${result.description}</div>
            <div style="padding:0.75rem;background:rgba(0,0,0,0.3);border-radius:6px;border-left:3px solid ${result.severity === 'critical' ? '#ff0000' : result.severity === 'warning' ? '#ffaa00' : 'var(--accent)'}">
              <div style="font-size:0.8rem;color:#999;margin-bottom:0.25rem">RECOMMENDATION</div>
              <div style="font-weight:600">${result.recommendation}</div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
      
      // Update statistics
      document.getElementById('criticalCount').textContent = critical;
      document.getElementById('warningCount').textContent = warning;
      document.getElementById('safeCount').textContent = safe;
    }
    
    function drawDetections(detections) {
      const overlay = document.getElementById('detectionOverlay');
      overlay.innerHTML = '';
      
      detections.boxes.forEach(box => {
        const boxEl = document.createElement('div');
        boxEl.className = 'detection-box';
        boxEl.style.left = box.x + '%';
        boxEl.style.top = box.y + '%';
        boxEl.style.width = box.width + '%';
        boxEl.style.height = box.height + '%';
        
        const labelEl = document.createElement('div');
        labelEl.className = 'detection-label';
        labelEl.textContent = box.label;
        boxEl.appendChild(labelEl);
        
        overlay.appendChild(boxEl);
      });
    }
    
    function captureImage() {
      const video = document.getElementById('videoElement');
      const canvas = document.getElementById('canvasElement');
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0);
      
      // Convert to blob and download
      canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cylinder-scan-${Date.now()}.jpg`;
        a.click();
        URL.revokeObjectURL(url);
      }, 'image/jpeg');
      
      alert('üì∏ Image captured and saved!');
    }
  </script>
</body>
</html>
